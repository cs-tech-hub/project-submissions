name: Auto Fork Student Repos

on:
  issues:
    types: [opened]
  workflow_dispatch:
  schedule:
    - cron: "*/10 * * * *"  # every 10 minutes

jobs:
  fork-student-repo:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    steps:
      - name: Install GitHub CLI
        run: sudo apt-get install -y gh jq

      - name: Authenticate gh CLI
        run: echo "${{ secrets.ORG_PAT }}" | gh auth login --with-token

      - name: Extract repo link from issue
        id: extract
        run: |
          body="${{ github.event.issue.body }}"
          repo_url=$(echo "$body" | grep -o 'https://github.com[^ ]*' | head -n 1)
          if [ -z "$repo_url" ]; then
            echo "‚ùå No GitHub repo link found in issue."
            exit 1
          fi
          echo "repo_url=$repo_url" >> $GITHUB_OUTPUT

      - name: Fork repo into org
        run: |
          repo_url="${{ steps.extract.outputs.repo_url }}"
          echo "üîÑ Forking $repo_url into org ncas-eduhub..."
          gh repo fork "$repo_url" --org ncas-eduhub --clone=false || echo "‚ö†Ô∏è Already forked"

  sync-forks:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Install GitHub CLI
        run: sudo apt-get install -y gh jq

      - name: Authenticate gh CLI
        run: echo "${{ secrets.ORG_PAT }}" | gh auth login --with-token

      - name: Sync all forks in org
        run: |
          echo "Fetching forks in org ncas-eduhub..."
          repos=$(gh repo list ncas-eduhub --json name,isFork --jq '.[] | select(.isFork==true) | .name')
          for repo in $repos; do
            echo "üîÑ Syncing fork: ncas-eduhub/$repo..."
            gh repo sync ncas-eduhub/$repo || echo "‚ö†Ô∏è Failed to sync $repo"
          done
