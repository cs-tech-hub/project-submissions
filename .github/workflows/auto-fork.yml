name: Auto Fork Student Repos

on:
  issues:
    types: [opened]

jobs:
  auto-fork:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repo
        uses: actions/checkout@v3

      - name: Extract repo URL from issue
        id: extract
        run: |
          echo "Issue body:"
          echo "${{ github.event.issue.body }}"
          # Extract GitHub repo URL from the issue body
          REPO_URL=$(echo "${{ github.event.issue.body }}" | grep -o 'https://github.com[^ ]*' | head -n 1)
          if [ -z "$REPO_URL" ]; then
            echo "No repo URL found in issue body. Please include a GitHub repo link."
            exit 1
          fi
          echo "repo_url=$REPO_URL" >> $GITHUB_OUTPUT

      - name: Fork repo into org
        env:
          ORG: ncas-eduhub   # your org name
          REPO_URL: ${{ steps.extract.outputs.repo_url }}
          GITHUB_TOKEN: ${{ secrets.ORG_PAT }}
        run: |
          echo "Forking repo: $REPO_URL into org: $ORG"

          # Extract owner and repo name
          OWNER=$(echo "$REPO_URL" | cut -d'/' -f4)
          REPO=$(echo "$REPO_URL" | cut -d'/' -f5)

          if [ -z "$OWNER" ] || [ -z "$REPO" ]; then
            echo "Invalid repo URL format: $REPO_URL"
            exit 1
          fi

          # Fork using GitHub API
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$OWNER/$REPO/forks \
            -d "{\"organization\":\"$ORG\"}"
          
          echo "✅ Repo $OWNER/$REPO forked into $ORG"

      - name: Comment on issue
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue_number = context.issue.number;
            const repo_url = "${{ steps.extract.outputs.repo_url }}";
            await github.rest.issues.createComment({
              ...context.repo,
              issue_number,
              body: `✅ The repository has been forked into **ncas-eduhub**!\n\nForked from: ${repo_url}`
            });
