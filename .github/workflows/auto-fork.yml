name: Auto Fork and Sync Student Repositories

on:
  issues:
    types: [opened]
  workflow_dispatch:
  schedule:
    - cron: "*/10 * * * *" # every 10 minutes

permissions:
  contents: write
  issues: write

jobs:
  process_issue:
    name: Fork Repo From Issue
    runs-on: ubuntu-latest
    if: github.event_name == 'issues'
    steps:
      - name: üîé Extract Repo URL from Issue
        id: extract
        run: |
          repo_url=$(echo "${{ github.event.issue.body }}" | grep -oP 'https://github\.com/[a-zA-Z0-9_-]+/[a-zA-Z0-9_.-]+' | head -n 1)
          if [[ -z "$repo_url" ]]; then
            echo "found=false" >> $GITHUB_OUTPUT
          else
            echo "repo_url=$repo_url" >> $GITHUB_OUTPUT
            echo "repo_name=$(basename $repo_url)" >> $GITHUB_OUTPUT
            echo "found=true" >> $GITHUB_OUTPUT
          fi

      - name: üçΩÔ∏è Fork Repository
        if: steps.extract.outputs.found == 'true'
        env:
          GH_TOKEN: ${{ secrets.ORG_PAT }}
        run: |
          repo_url="${{ steps.extract.outputs.repo_url }}"
          repo_name="${{ steps.extract.outputs.repo_name }}"
          org_name="ncas-eduhub"

          if gh repo view "$org_name/$repo_name" >/dev/null 2>&1; then
            echo "comment_body=‚úÖ Repo [$repo_name] already forked." >> $GITHUB_ENV
          else
            gh repo fork "$repo_url" --org "$org_name" --clone=false
            echo "comment_body=‚úÖ Forked [$repo_name] into $org_name." >> $GITHUB_ENV
          fi

      - name: üí¨ Comment on Issue
        if: steps.extract.outputs.found == 'true'
        env:
          GH_TOKEN: ${{ secrets.ORG_PAT }}
        run: gh issue comment ${{ github.event.issue.number }} --body "${{ env.comment_body }}"

      - name: ‚ö†Ô∏è Comment if No URL Found
        if: steps.extract.outputs.found != 'true'
        env:
          GH_TOKEN: ${{ secrets.ORG_PAT }}
        run: gh issue comment ${{ github.event.issue.number }} --body "‚ö†Ô∏è Please include a valid GitHub repo URL."

  sync_forks:
    name: Sync All Organization Forks
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - name: üîÑ Sync All Forks
        env:
          GH_TOKEN: ${{ secrets.ORG_PAT }}
        run: |
          echo "Fetching forks in org 'ncas-eduhub'..."
          gh repo list ncas-eduhub --fork --limit 1000 --json "nameWithOwner" --jq '.[].nameWithOwner' | while read -r repo; do
            echo "Syncing $repo..."
            gh repo sync "$repo" || echo "‚ö†Ô∏è Could not sync $repo (ahead of upstream)."
          done
          echo "‚úÖ Sync complete."
