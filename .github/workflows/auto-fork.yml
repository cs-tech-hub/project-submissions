name: Auto Fork Student Repos

on:
  push:
    paths:
      - "repos.txt"   # only trigger when repos.txt changes
  workflow_dispatch:   # also allow manual run

jobs:
  fork-repos:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install GitHub CLI
        run: sudo apt-get install -y gh jq

      - name: Authenticate gh CLI
        run: echo "${{ secrets.ORG_PAT }}" | gh auth login --with-token

      - name: Fork repos into org (safe mode)
        run: |
          ORG="ncas-eduhub"

          # Read repos from repos.txt
          while IFS= read -r repo_url; do
            [ -z "$repo_url" ] && continue   # skip empty lines
            repo_name=$(basename "$repo_url" .git)

            echo "🔍 Checking $repo_url..."

            # Check if repo already exists in org
            if gh repo view "$ORG/$repo_name" >/dev/null 2>&1; then
              echo "✅ Already exists in org: $ORG/$repo_name (skip)"
            else
              echo "🔄 Forking $repo_url into $ORG..."
              gh repo fork "$repo_url" --org "$ORG" --clone=false || echo "⚠️ Failed to fork $repo_url"
            fi
          done < repos.txt

          echo "🎉 Forking process completed. Note: Existing forks are never deleted."
