name: Auto Fork Student Repos

on:
  issues:
    types: [opened, edited]   # runs when a student submits/edits repo link
  schedule:
    - cron: "*/10 * * * *"    # also runs every 10 minutes to sync all repos
  workflow_dispatch:           # allow manual run

jobs:
  handle-issue:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    steps:
      - name: Authenticate gh CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Extract repo link from issue
        id: extract
        run: |
          echo "ISSUE_BODY='${{ github.event.issue.body }}'" >> $GITHUB_ENV
          # Expect repo link like https://github.com/user/repo
          REPO_URL=$(echo "${{ github.event.issue.body }}" | grep -oE 'https://github.com/[a-zA-Z0-9._-]+/[a-zA-Z0-9._-]+')
          if [ -z "$REPO_URL" ]; then
            echo "No valid GitHub repo link found in issue body"
            exit 1
          fi
          echo "REPO_URL=$REPO_URL" >> $GITHUB_ENV
          OWNER=$(echo $REPO_URL | cut -d'/' -f4)
          REPO=$(echo $REPO_URL | cut -d'/' -f5)
          echo "SRC_OWNER=$OWNER" >> $GITHUB_ENV
          echo "SRC_REPO=$REPO" >> $GITHUB_ENV

      - name: Fork into org
        run: |
          echo "Forking $SRC_OWNER/$SRC_REPO into org ncas-eduhub..."
          gh repo fork $SRC_OWNER/$SRC_REPO --org ncas-eduhub --remote=false --clone=false --default-branch-only
        env:
          SRC_OWNER: ${{ env.SRC_OWNER }}
          SRC_REPO: ${{ env.SRC_REPO }}

  sync-repos:
    if: github.event_name != 'issues'
    runs-on: ubuntu-latest
    steps:
      - name: Authenticate gh CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Sync all student repos
        run: |
          echo "Fetching all repos under org ncas-eduhub..."
          gh repo list ncas-eduhub --limit 200 --json nameWithOwner -q '.[].nameWithOwner' > repos.txt
          while IFS= read -r repo; do
            echo "Syncing $repo..."
            gh repo sync "$repo"
          done < repos.txt
