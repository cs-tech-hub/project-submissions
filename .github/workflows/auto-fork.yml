name: Auto Fork & Sync Student Repos

on:
  issues:
    types: [opened, edited]   # when student submits repo link
  schedule:
    - cron: "*/10 * * * *"    # sync all forks every 10 minutes
  workflow_dispatch:          # allow manual run if needed

jobs:
  handle-issue:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install GitHub CLI
        run: sudo apt-get install -y gh jq

      - name: Authenticate gh CLI
        run: echo "${{ secrets.ORG_PAT }}" | gh auth login --with-token

      - name: Parse repo link from issue
        id: parse
        run: |
          body="${{ github.event.issue.body }}"
          echo "Issue body: $body"
          repo_url=$(echo "$body" | grep -o 'https://github.com[^ ]*' | head -n1)
          if [ -z "$repo_url" ]; then
            echo "‚ùå No repo URL found in issue body"
            exit 1
          fi
          echo "repo_url=$repo_url" >> $GITHUB_ENV

      - name: Fork repo into org
        run: |
          echo "Forking $repo_url into ncas-eduhub..."
          gh repo fork "$repo_url" --org ncas-eduhub --clone=false --default-branch-only

  sync-forks:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Install GitHub CLI
        run: sudo apt-get install -y gh jq

      - name: Authenticate gh CLI
        run: echo "${{ secrets.ORG_PAT }}" | gh auth login --with-token

      - name: Sync all forks in org
        run: |
          echo "Fetching all repos under org ncas-eduhub..."
          repos=$(gh repo list ncas-eduhub --json name --jq '.[].name')
          for repo in $repos; do
            echo "üîÑ Syncing ncas-eduhub/$repo..."
            gh repo sync ncas-eduhub/$repo || echo "‚ö†Ô∏è Failed to sync $repo"
          done
