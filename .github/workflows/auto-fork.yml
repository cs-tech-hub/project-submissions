name: Auto Fork Student Repos

on:
  issues:
    types: [opened]   # only run when a new issue is opened
  workflow_dispatch:   # allow manual run from Actions tab too

jobs:
  fork-student-repo:
    runs-on: ubuntu-latest

    steps:
      - name: Install GitHub CLI
        run: sudo apt-get update && sudo apt-get install -y gh jq

      - name: Authenticate gh CLI
        run: echo "${{ secrets.ORG_PAT }}" | gh auth login --with-token

      - name: Extract repo link from issue
        id: extract
        run: |
          echo "Issue body: ${{ github.event.issue.body }}"
          repo_url=$(echo "${{ github.event.issue.body }}" | grep -o 'https://github.com[^ ]*' | head -n 1)

          if [ -z "$repo_url" ]; then
            echo "❌ No GitHub repo link found in issue."
            exit 1
          fi

          echo "✅ Found repo: $repo_url"
          echo "repo_url=$repo_url" >> $GITHUB_OUTPUT

      - name: Fork repo into org
        run: |
          repo_url="${{ steps.extract.outputs.repo_url }}"
          echo "🔄 Forking $repo_url into org ncas-eduhub..."
          gh repo fork "$repo_url" --org ncas-eduhub --clone=false --remote=false || {
            echo "❌ Fork failed! Check if ORG_PAT has org permissions."
            exit 1
          }
          echo "✅ Fork completed successfully!"
